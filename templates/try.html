<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ultra Telegram — Prototype</title>
<style>
  :root{
    --bg:#f5f7fb;
    --panel:#ffffff;
    --muted:#7b8594;
    --accent:#2b8cff;
    --accent-2:#6a5cff;
    --incoming:#e9f3ff;
    --outgoing:#d6f5d6;
    --glass: rgba(255,255,255,0.6);
    --shadow: 0 6px 18px rgba(22,28,37,0.08);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  :root.dark{
    --bg:#0b1220;
    --panel:#0f1724;
    --muted:#9aa4b2;
    --accent:#5aa1ff;
    --accent-2:#8a76ff;
    --incoming:#162430;
    --outgoing:#14321a;
    --glass: rgba(255,255,255,0.03);
    --shadow: none;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    height:100%;
    background: linear-gradient(180deg,var(--bg),#e9eef9 60%);
    display:flex;
    align-items:stretch;
    color:var(--muted);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* App layout */
  .app{
    margin:auto;
    width:100%;
    max-width:1200px;
    height:88vh;
    display:grid;
    grid-template-columns:320px 1fr;
    gap:18px;
    padding:18px;
  }

  /* Sidebar */
  .sidebar{
    background:linear-gradient(180deg,var(--panel),var(--glass));
    border-radius:14px;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    border:1px solid rgba(0,0,0,0.03);
  }
  .sidebar .top{
    padding:14px;
    display:flex;
    gap:12px;
    align-items:center;
  }
  .avatar{
    width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;
    box-shadow:0 6px 16px rgba(42, 138, 255, 0.18);
  }
  .app-title{font-weight:700;color:var(--muted);line-height:1}
  .app-sub{font-size:12px;color:var(--muted);opacity:0.8}

  .search{
    padding:10px 14px;
    display:flex;
    gap:8px;
    align-items:center;
    border-top:1px solid rgba(0,0,0,0.03);
    border-bottom:1px solid rgba(0,0,0,0.03);
  }
  .search input{
    width:100%;
    border:0;background:transparent;padding:8px 10px;border-radius:10px;
    outline:none;color:var(--muted);
  }
  .list{
    overflow:auto;padding:8px;
  }

  .contact{
    display:flex;gap:10px;padding:10px;border-radius:10px;align-items:center;cursor:pointer;
    transition:background .14s;
  }
  .contact:hover{background:rgba(0,0,0,0.02)}
  .contact.active{background:linear-gradient(90deg, rgba(43,140,255,0.07), rgba(106,92,255,0.03));border-left:3px solid var(--accent);padding-left:7px}
  .contact .c-avatar{width:44px;height:44px;border-radius:10px;background:#ddd;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  .contact .c-info{flex:1;min-width:0}
  .c-name{font-weight:600;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .c-last{font-size:12px;color:var(--muted);opacity:0.7}
  .badge{background:var(--accent);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px}

  /* Chat panel */
  .chat{
    background:linear-gradient(180deg,var(--panel),var(--glass));
    border-radius:14px;
    box-shadow:var(--shadow);
    display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(0,0,0,0.03);
  }
  .chat .header{
    padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(0,0,0,0.03);
  }
  .chat .header .name{font-weight:700;color:var(--muted)}
  .chat .header .meta{font-size:13px;color:var(--muted);opacity:0.75}

  .messages{
    padding:18px;
    display:flex;flex-direction:column;gap:10px;
    flex:1;overflow:auto;background:
      linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.01) 100%);
  }
  .msg-row{display:flex;gap:10px;align-items:flex-end;max-width:85%}
  .msg-row.me{margin-left:auto;flex-direction:row-reverse}
  .bubble{
    padding:10px 12px;border-radius:12px;line-height:1.3;font-size:14px;color:#122;
    box-shadow:0 2px 8px rgba(16,24,40,0.04);max-width:680px;word-wrap:break-word;
  }
  .bubble.in{background:var(--incoming);color:var(--muted)}
  .bubble.out{background:var(--outgoing);color:#063a00}
  .meta-row{display:flex;gap:8px;font-size:12px;color:var(--muted);opacity:0.8;margin-top:6px}
  .timestamp{font-size:11px;opacity:0.7}

  .composer{
    padding:12px;display:flex;gap:10px;border-top:1px solid rgba(0,0,0,0.03);align-items:flex-end;
  }
  .composer .tools{display:flex;gap:8px;align-items:center}
  .composer textarea{
    flex:1;min-height:44px;max-height:140px;border-radius:12px;padding:10px;border:1px solid rgba(0,0,0,0.05);
    resize:none;outline:none;background:transparent;color:var(--muted);
    font-size:14px;
  }
  .btn{
    background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600;
    box-shadow:0 6px 18px rgba(43,140,255,0.12);
  }
  .icon-btn{background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
  .emoji-picker{position:absolute;right:20px;bottom:86px;background:var(--panel);border-radius:10px;padding:8px;display:grid;grid-template-columns:repeat(6,30px);gap:6px;box-shadow:var(--shadow)}
  .emoji{cursor:pointer;font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center;padding:4px;border-radius:6px}
  .small{font-size:12px;color:var(--muted)}

  /* message actions */
  .msg-actions{display:flex;gap:8px;margin-left:8px}
  .reaction{cursor:pointer;padding:4px;border-radius:6px;font-size:14px}

  /* mobile */
  @media (max-width:860px){
    .app{grid-template-columns:1fr;max-width:960px;height:92vh}
    .sidebar{order:2}
    .chat{order:1}
    .avatar{width:40px;height:40px}
  }

  /* tiny helper */
  .muted{color:var(--muted);font-size:13px}
  .flex{display:flex;align-items:center}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="sidebar" aria-label="Contacts sidebar">
    <div class="top">
      <div class="avatar" id="appAvatar">UT</div>
      <div>
        <div class="app-title">Ultra Telegram</div>
        <div class="app-sub">Secure prototype</div>
      </div>
      <div style="margin-left:auto" class="flex">
        <button class="icon-btn" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">
          <!-- moon/sun icon -->
          <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg>
        </button>
      </div>
    </div>

    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="contactSearch" placeholder="Search contacts or messages" aria-label="Search contacts" />
    </div>

    <div class="list" id="contactsList" role="list">
      <!-- contacts injected -->
    </div>
  </div>

  <main class="chat" aria-label="Chat panel">
    <div class="header">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="c-avatar" id="chatAvatar" style="width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--accent-2));">A</div>
        <div>
          <div class="name" id="chatName">Select a chat</div>
          <div class="meta small" id="chatMeta">Last seen recently</div>
        </div>
      </div>
      <div style="margin-left:auto" class="flex">
        <button class="icon-btn" id="newChatBtn" title="New Chat">＋ New</button>
      </div>
    </div>

    <div class="messages" id="messages" aria-live="polite">
      <div class="muted" style="text-align:center;margin-top:50px">No chat selected — choose a contact or create a new chat.</div>
    </div>

    <div class="composer" id="composer">
      <div class="tools" style="position:relative">
        <button class="icon-btn" id="emojiBtn" title="Emoji">😊</button>
        <button class="icon-btn" id="attachBtn" title="Attach">📎</button>
      </div>
      <textarea id="input" placeholder="Type a message — Enter to send, Shift+Enter for newline" aria-label="Message input"></textarea>
      <button class="btn" id="sendBtn">Send</button>
    </div>
  </main>
</div>

<!-- tiny templates & data -->
<script>
/* ========= Ultra Telegram - Single File JS ========= */

// Sample data
const SAMPLE = [
  { id: 'c1', name: 'Aria Thomas', avatar: 'AT', last: 'Hey! you free later?', unread: 2, lastTime: Date.now()-1000*60*60*4 },
  { id: 'c2', name: 'Dev Squad', avatar: 'DS', last: 'Deployed to staging', unread: 0, lastTime: Date.now()-1000*60*30 },
  { id: 'c3', name: 'Mom', avatar: 'M', last: 'Dinner at 7?', unread: 1, lastTime: Date.now()-1000*60*60*24 },
];

// Storage helpers
const STORAGE_KEY = 'ultra-telegram-v1';

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) {
      // initialize with sample conversations having one message each
      const convs = {};
      SAMPLE.forEach((c,i)=>{
        convs[c.id] = {
          contact:c,
          messages:[
            { id: `${c.id}-m1`, from: i===0 ? 'them' : (i===1?'them':'them'), text:c.last, ts:c.lastTime, read: false }
          ]
        };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ convs, selected: 'c1', theme: localStorage.getItem('ultra-theme') || 'light' }));
      return JSON.parse(localStorage.getItem(STORAGE_KEY));
    }
    return JSON.parse(raw);
  }catch(e){
    console.error('loadState error',e); return null;
  }
}
function saveState(state){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// Format time
function fmtTime(ts){
  const d = new Date(ts);
  const now = new Date();
  const sameDay = d.toDateString() === now.toDateString();
  return sameDay ? d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : d.toLocaleDateString();
}

/* App state */
let STATE = loadState();
if(!STATE) STATE = { convs: {}, selected: null, theme: 'light' };

// DOM refs
const contactsList = document.getElementById('contactsList');
const messagesEl = document.getElementById('messages');
const chatName = document.getElementById('chatName');
const chatMeta = document.getElementById('chatMeta');
const chatAvatar = document.getElementById('chatAvatar');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const emojiBtn = document.getElementById('emojiBtn');
const attachBtn = document.getElementById('attachBtn');
const emojiPickerId = 'emojiPicker';
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const contactSearch = document.getElementById('contactSearch');
const newChatBtn = document.getElementById('newChatBtn');

// simple emoji set
const EMOJIS = ['😀','😄','😂','😊','😍','🤔','😮','😢','👍','🔥','🚀','🎉','🤝','🙌','💡','✌️'];

// initialize theme
(function initTheme(){
  const prefer = STATE.theme || (localStorage.getItem('ultra-theme') || 'light');
  if(prefer === 'dark') document.documentElement.classList.add('dark');
  updateThemeIcon();
})();

function updateThemeIcon(){
  const dark = document.documentElement.classList.contains('dark');
  themeIcon.innerHTML = dark
    ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>' // moon
    : '<path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4M12 7a5 5 0 100 10 5 5 0 000-10z"></path>'; // sun-ish
}

// render contacts
function renderContacts(filter=''){
  contactsList.innerHTML = '';
  const convs = Object.values(STATE.convs);
  // sort by last message timestamp desc
  convs.sort((a,b)=>{
    const ta = a.messages[a.messages.length-1]?.ts || 0;
    const tb = b.messages[b.messages.length-1]?.ts || 0;
    return tb - ta;
  });
  convs.forEach(cnv=>{
    const contact = cnv.contact;
    const lastMsg = cnv.messages[cnv.messages.length-1];
    const lastText = lastMsg ? lastMsg.text : '';
    const li = document.createElement('div');
    li.className = 'contact' + (STATE.selected === contact.id ? ' active' : '');
    li.setAttribute('role','listitem');
    li.innerHTML = `
      <div class="c-avatar" style="background: linear-gradient(135deg, ${hashColor(contact.name)}, ${shiftColor(hashColor(contact.name))});">${contact.avatar}</div>
      <div class="c-info">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="c-name">${contact.name}</div>
          <div style="margin-left:auto;font-size:12px;color:var(--muted);opacity:0.75">${lastMsg ? fmtTime(lastMsg.ts) : ''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="c-last">${lastText.length>40? lastText.slice(0,40)+'…' : lastText}</div>
          ${contact.unread ? `<div style="margin-left:auto"><span class="badge">${contact.unread}</span></div>` : ''}
        </div>
      </div>
    `;
    if(filter && !(contact.name.toLowerCase().includes(filter.toLowerCase()) || lastText.toLowerCase().includes(filter.toLowerCase()))){
      // skip showing
      return;
    }
    li.addEventListener('click', ()=>{ selectChat(contact.id); });
    contactsList.appendChild(li);
  });
}

// select chat
function selectChat(id){
  if(!STATE.convs[id]) return;
  STATE.selected = id;
  // mark messages as read
  STATE.convs[id].contact.unread = 0;
  STATE.convs[id].messages.forEach(m=>m.read = true);
  saveState(STATE);
  renderContacts(contactSearch.value);
  renderChat();
}

// render chat panel
function renderChat(){
  messagesEl.innerHTML = '';
  const sel = STATE.selected;
  if(!sel || !STATE.convs[sel]) {
    chatName.textContent = 'Select a chat';
    chatMeta.textContent = 'No chat selected';
    chatAvatar.textContent = 'A';
    messagesEl.innerHTML = '<div class="muted" style="text-align:center;margin-top:50px">No chat selected — choose a contact or create a new chat.</div>';
    return;
  }
  const cnv = STATE.convs[sel];
  chatName.textContent = cnv.contact.name;
  chatMeta.textContent = cnv.contact.last || 'Active';
  chatAvatar.textContent = cnv.contact.avatar;
  chatAvatar.style.background = `linear-gradient(135deg, ${hashColor(cnv.contact.name)}, ${shiftColor(hashColor(cnv.contact.name))})`;

  cnv.messages.forEach(msg=>{
    const row = document.createElement('div');
    row.className = 'msg-row' + (msg.from === 'me' ? ' me' : '');
    row.dataset.mid = msg.id;
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (msg.from === 'me' ? 'out' : 'in');
    bubble.innerHTML = `<div>${escapeHtml(msg.text)}</div>
      <div class="meta-row"><div class="timestamp">${fmtTime(msg.ts)}</div>
      ${msg.from==='me' ? `<div class="small" style="margin-left:6px">${msg.read? '✓✓' : '✓'}</div>` : ''}
      </div>`;
    row.appendChild(bubble);

    // message actions
    const actions = document.createElement('div');
    actions.className = 'msg-actions';
    const reactBtn = document.createElement('button');
    reactBtn.className = 'icon-btn reaction';
    reactBtn.title = 'React';
    reactBtn.innerText = '👍';
    reactBtn.addEventListener('click', ()=> {
      // naive reaction append
      msg.reaction = msg.reaction === '👍' ? null : '👍';
      saveState(STATE);
      renderChat();
    });
    actions.appendChild(reactBtn);

    const moreBtn = document.createElement('button');
    moreBtn.className = 'icon-btn';
    moreBtn.title = 'More';
    moreBtn.innerHTML = '⋯';
    moreBtn.addEventListener('click', ()=> showMsgMenu(msg, row));
    actions.appendChild(moreBtn);

    row.appendChild(actions);

    // show reaction if exists
    if(msg.reaction){
      const R = document.createElement('div');
      R.className = 'small';
      R.style.marginLeft = '8px';
      R.textContent = msg.reaction;
      row.appendChild(R);
    }

    messagesEl.appendChild(row);
  });

  // scroll to bottom
  setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 40);
}

// message menu
function showMsgMenu(msg, row){
  // small quick menu: edit / delete / copy timestamp
  const menu = document.createElement('div');
  menu.style.position='absolute';
  menu.style.background = getComputedStyle(document.documentElement).getPropertyValue('--panel');
  menu.style.padding='8px';
  menu.style.borderRadius='8px';
  menu.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';
  menu.style.zIndex=9999;
  menu.style.fontSize='13px';
  menu.style.color=getComputedStyle(document.documentElement).getPropertyValue('--muted');
  const edit = document.createElement('div'); edit.textContent='Edit message'; edit.style.padding='6px'; edit.style.cursor='pointer';
  const del = document.createElement('div'); del.textContent='Delete message'; del.style.padding='6px'; del.style.cursor='pointer';
  const ts = document.createElement('div'); ts.textContent='Copy timestamp'; ts.style.padding='6px'; ts.style.cursor='pointer';
  menu.appendChild(edit); menu.appendChild(del); menu.appendChild(ts);

  document.body.appendChild(menu);
  const rect = row.getBoundingClientRect();
  menu.style.left = (rect.right - menu.offsetWidth - 20) + 'px';
  menu.style.top = (rect.top + window.scrollY - 10) + 'px';

  const removeMenu = ()=> { if(menu && menu.parentNode) menu.parentNode.removeChild(menu); };

  edit.addEventListener('click', ()=>{
    removeMenu();
    if(msg.from !== 'me'){ alert('You can only edit your own messages in this prototype.'); return; }
    const newText = prompt('Edit message:', msg.text);
    if(newText != null){ msg.text = newText; msg.edited = true; msg.ts = Date.now(); saveState(STATE); renderChat(); }
  });
  del.addEventListener('click', ()=>{
    removeMenu();
    if(confirm('Delete this message?')){
      const cnv = STATE.convs[STATE.selected];
      cnv.messages = cnv.messages.filter(m=>m.id !== msg.id);
      saveState(STATE);
      renderChat();
    }
  });
  ts.addEventListener('click', ()=>{
    navigator.clipboard?.writeText(new Date(msg.ts).toString());
    removeMenu();
    alert('Timestamp copied to clipboard.');
  });

  document.addEventListener('click', function onDoc(e){
    if(!menu.contains(e.target)) { removeMenu(); document.removeEventListener('click', onDoc); }
  });
}

// send message
function sendMessage(text, attach=false){
  const sel = STATE.selected;
  if(!sel) { alert('Select a chat first.'); return; }
  const cnv = STATE.convs[sel];
  const id = `${sel}-m${Date.now()}`;
  const msg = { id, from:'me', text, ts: Date.now(), read:false };
  cnv.messages.push(msg);
  cnv.contact.last = text;
  cnv.contact.lastTime = msg.ts;
  // simulate remote reply for demo
  saveState(STATE);
  renderContacts(contactSearch.value);
  renderChat();
  // simulate reply after short delay
  setTimeout(()=>simulateReply(sel), 700 + Math.random()*1400);
}

// simulate a reply (toy)
function simulateReply(sel){
  const cnv = STATE.convs[sel];
  if(!cnv) return;
  const repli = [
    "Nice!",
    "Haha 😂",
    "On it.",
    "Perfect — thanks!",
    "Let's do this tomorrow.",
    "Can you share details?",
    "Love it 🔥"
  ];
  const text = repli[Math.floor(Math.random()*repli.length)];
  const id = `${sel}-m${Date.now()}`;
  const msg = { id, from: 'them', text, ts: Date.now(), read:false };
  cnv.messages.push(msg);
  cnv.contact.last = text;
  cnv.contact.lastTime = msg.ts;
  cnv.contact.unread = (cnv.contact.unread||0) + 1;
  saveState(STATE);
  renderContacts(contactSearch.value);
  // if the chat is currently selected, mark read and render
  if(STATE.selected === sel){
    cnv.messages.forEach(m=>m.read = true);
    cnv.contact.unread = 0;
  }
  renderChat();
}

// helper: escape html
function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// tiny color generator based on name
function hashColor(name){
  // deterministic pastel hues
  let h = 0;
  for(let i=0;i<name.length;i++) h = name.charCodeAt(i) + ((h<<5)-h);
  const hue = Math.abs(h) % 360;
  return `hsl(${hue} 80% 55%)`;
}
function shiftColor(c){
  // produce second color by altering lightness
  return c.replace('55%)','65%)');
}

/* UI events */
sendBtn.addEventListener('click', ()=>{
  const val = input.value.trim();
  if(!val) return;
  sendMessage(val);
  input.value = '';
  input.focus();
});

// enter behavior
input.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});

// emoji picker toggle
let emojiOpen = false;
emojiBtn.addEventListener('click', (e)=>{
  emojiOpen = !emojiOpen;
  if(emojiOpen) openEmojiPicker(); else closeEmojiPicker();
});
function openEmojiPicker(){
  closeEmojiPicker();
  const picker = document.createElement('div');
  picker.id = emojiPickerId;
  picker.className = 'emoji-picker';
  EMOJIS.forEach(em=>{
    const b = document.createElement('div');
    b.className = 'emoji';
    b.textContent = em;
    b.addEventListener('click', ()=>{ input.value += em; input.focus(); closeEmojiPicker(); });
    picker.appendChild(b);
  });
  document.body.appendChild(picker);
  // position near emojiBtn
  const rect = emojiBtn.getBoundingClientRect();
  picker.style.left = (rect.right - picker.offsetWidth) + 'px';
  picker.style.top = (rect.top + window.scrollY - picker.offsetHeight - 8) + 'px';
}
function closeEmojiPicker(){
  const old = document.getElementById(emojiPickerId);
  if(old) old.remove();
  emojiOpen = false;
}

// attach (simulated)
attachBtn.addEventListener('click', ()=>{
  const file = prompt('Simulate attach: enter a short filename (e.g., report.pdf)');
  if(file){
    sendMessage(`[file: ${file}]`, true);
  }
});

// theme toggle
themeToggle.addEventListener('click', ()=>{
  const dark = document.documentElement.classList.toggle('dark');
  STATE.theme = dark ? 'dark' : 'light';
  localStorage.setItem('ultra-theme', STATE.theme);
  updateThemeIcon();
  saveState(STATE);
});

// search
contactSearch.addEventListener('input', (e)=> renderContacts(e.target.value) );

// new chat
newChatBtn.addEventListener('click', ()=>{
  const nm = prompt('New chat — enter contact name:');
  if(!nm) return;
  const id = 'c' + Math.floor(Math.random()*1000000);
  const contact = { id, name: nm, avatar: nm.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase(), unread:0, lastTime: Date.now() };
  STATE.convs[id] = { contact, messages: [ { id: `${id}-m1`, from:'them', text: 'Hey, I joined Ultra Telegram!', ts: Date.now(), read: false } ]};
  STATE.selected = id;
  saveState(STATE);
  renderContacts(contactSearch.value);
  renderChat();
});

// initial render
(function bootstrap(){
  // ensure sample convs present if none
  const k = Object.keys(STATE.convs).length;
  if(k === 0){
    SAMPLE.forEach((c)=>{
      STATE.convs[c.id] = { contact: c, messages:[ { id: `${c.id}-m1`, from:'them', text:c.last, ts:c.lastTime, read:false } ] };
    });
    STATE.selected = SAMPLE[0].id;
    saveState(STATE);
  }
  renderContacts();
  if(!STATE.selected) STATE.selected = Object.keys(STATE.convs)[0];
  renderChat();
})();

/* Accessibility: focus composer */
input.addEventListener('focus', ()=> {
  // small visual cue if needed
});

/* Save on unload */
window.addEventListener('beforeunload', ()=> saveState(STATE));

</script>
</body>
</html>