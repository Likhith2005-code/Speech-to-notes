<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ultra Messenger — Single File</title>
<style>
  :root{
    --bg:#0f1724;
    --panel:#0b1220;
    --muted:#98a0b3;
    --accent:#6ee7b7;
    --accent-2:#60a5fa;
    --me:#1f2a44;
    --them:#111827;
    --glass: rgba(255,255,255,0.03);
    --success: #10b981;
    --danger: #ef4444;
    --max-width:1100px;
    --radius:12px;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg,#071029 0%, #071018 60%), var(--bg);
    color:#e6eef8;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .app {
    width:100%;
    max-width: var(--max-width);
    height: calc(100vh - 40px);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: 14px;
    display:grid;
    grid-template-columns: 320px 1fr;
    overflow:hidden;
    box-shadow: 0 10px 30px rgba(2,6,23,0.7), inset 0 1px 0 rgba(255,255,255,0.02);
  }

  /* Sidebar */
  .sidebar{
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    border-right: 1px solid rgba(255,255,255,0.03);
    padding:18px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .logo{
    width:46px;height:46px;border-radius:10px;
    display:grid;place-items:center;font-weight:700;
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    color: #042028; font-size:16px;
    box-shadow: 0 4px 12px rgba(96,165,250,0.12), inset 0 -2px 6px rgba(0,0,0,0.15);
  }
  .brand h1{font-size:16px;margin:0}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  .searchbox{
    display:flex;
    gap:8px;
    align-items:center;
    background:var(--glass);
    padding:8px;
    border-radius:10px;
  }
  .searchbox input{
    border:0;background:transparent;color:inherit;outline:none;width:100%;
    font-size:13px;
  }

  .conversations{
    overflow:auto;
    padding-right:6px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .conv-item{
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px;
    border-radius:10px;
    cursor:pointer;
  }
  .conv-item:hover{background: rgba(255,255,255,0.015)}
  .conv-item.active{background: linear-gradient(90deg, rgba(96,165,250,0.08), rgba(110,231,183,0.03)); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);}
  .avatar{
    width:44px;height:44px;border-radius:10px;background:#0b1220;display:grid;place-items:center;font-weight:700;
    color:var(--accent-2);
    flex:0 0 44px;
  }
  .conv-main{flex:1;min-width:0}
  .conv-main h3{margin:0;font-size:14px}
  .conv-main p{margin:4px 0 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .conv-meta{font-size:12px;color:var(--muted);flex-shrink:0}

  .footer-short{
    margin-top:auto;
    font-size:12px;color:var(--muted);
    display:flex;justify-content:space-between;align-items:center;
  }

  /* Chat area */
  .chat{
    display:flex;
    flex-direction:column;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  }
  .chat-header{
    display:flex;align-items:center;gap:12px;padding:16px;border-bottom:1px solid rgba(255,255,255,0.02);
  }
  .chat-header .title{font-size:16px;margin:0}
  .chat-header .sub{font-size:12px;color:var(--muted)}
  .header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}

  .messages{
    padding:18px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
    background-image: linear-gradient(transparent 0 48px, rgba(255,255,255,0.00) 48px);
    flex:1;
  }
  .day-sep{
    display:flex;align-items:center;gap:12px;color:var(--muted);font-size:12px;
    justify-content:center;
  }
  .bubble{
    max-width:68%;
    padding:12px 14px;
    border-radius:14px;
    position:relative;
    line-height:1.35;
    font-size:14px;
    word-break:break-word;
  }
  .msg.me{align-self:flex-end;background:linear-gradient(180deg,var(--me),#16243b); color:#cfeef0;border-bottom-right-radius:6px}
  .msg.them{align-self:flex-start;background:linear-gradient(180deg,var(--them),#0f1724); color:#e6eef8;border-bottom-left-radius:6px}
  .meta{
    display:flex;gap:8px;align-items:center;margin-top:6px;font-size:12px;color:var(--muted);
  }
  .msg-row{display:flex;gap:8px;align-items:flex-end;}
  .msg-row.me{justify-content:flex-end}
  .msg-actions{
    display:flex;gap:6px;margin-left:6px;
    opacity:0;transition:opacity .12s;
  }
  .msg:hover .msg-actions{opacity:1}
  .action-btn{background:transparent;border:0;color:var(--muted);cursor:pointer;padding:6px;border-radius:6px}
  .action-btn:hover{background:rgba(255,255,255,0.02)}

  .composer{
    padding:12px 16px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:12px;align-items:center;
  }
  .input{
    background:transparent;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;flex:1;min-height:44px;display:flex;gap:8px;align-items:center;
  }
  .input textarea{flex:1;border:0;background:transparent;color:inherit;outline:none;resize:none;font-size:14px;padding:6px 4px}
  .send-btn{
    background:linear-gradient(90deg,var(--accent-2),var(--accent));padding:10px 14px;border-radius:10px;border:0;color:#042028;font-weight:700;cursor:pointer;
    box-shadow:0 6px 18px rgba(6,32,63,0.45);
  }

  /* small screens */
  @media (max-width:900px){
    .app{grid-template-columns:1fr; height:calc(100vh - 20px)}
    .sidebar{display:none}
  }

  /* nice small UI touches */
  .small{
    font-size:12px;color:var(--muted)
  }
  .file-preview{display:flex;gap:8px;align-items:center}
  .preview-thumb{width:58px;height:44px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}
  .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Ultra Messenger app">
    <aside class="sidebar" aria-label="Sidebar with conversations">
      <div class="brand" role="banner">
        <div class="logo" aria-hidden="true">UM</div>
        <div>
          <h1>Ultra Messenger</h1>
          <p class="small">Fast, local & privacy-friendly</p>
        </div>
      </div>

      <div class="searchbox" title="Search conversations or messages">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.5"/></svg>
        <input id="global-search" placeholder="Search messages or contacts..." aria-label="Search messages or contacts">
      </div>

      <div class="conversations" id="conversations" role="list" aria-label="Conversation list">
        <!-- conversation items rendered here -->
      </div>

      <div class="footer-short">
        <div class="small">Local-only · no servers</div>
        <div class="pill">v1.0</div>
      </div>
    </aside>

    <main class="chat" aria-live="polite">
      <header class="chat-header">
        <div class="avatar" id="chat-avatar" aria-hidden="true">AL</div>
        <div>
          <h2 class="title" id="chat-title">Alex</h2>
          <div class="sub small" id="chat-sub">Online</div>
        </div>
        <div class="header-actions" role="toolbar" aria-label="Chat actions">
          <button id="btn-clear" class="action-btn" title="Clear conversation">Clear</button>
          <button id="btn-export" class="action-btn" title="Export conversation">Export</button>
        </div>
      </header>

      <section class="messages" id="messages" tabindex="0" aria-label="Messages">
        <!-- messages rendered here -->
      </section>

      <form class="composer" id="composer" onsubmit="return false" aria-label="Message composer">
        <label for="file-input" class="action-btn" title="Attach image">
          📎
        </label>
        <input id="file-input" type="file" accept="image/*" style="display:none" />
        <div class="input" role="textbox" aria-multiline="true">
          <textarea id="message-input" placeholder="Write a message..." rows="1" aria-label="Write a message"></textarea>
        </div>
        <button id="send-btn" class="send-btn" aria-label="Send message" title="Send message">Send</button>
      </form>
    </main>
  </div>

<script>
/*
 Ultra Messenger
 Single-file demo: UI + behavior
*/
(() => {
  // Utilities
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const formatTime = ts => {
    const d = new Date(ts);
    const hh = d.getHours().toString().padStart(2,'0');
    const mm = d.getMinutes().toString().padStart(2,'0');
    return hh + ':' + mm;
  }
  const uid = () => Math.random().toString(36).slice(2,9);

  // DOM
  const conversationsEl = qs('#conversations');
  const messagesEl = qs('#messages');
  const inputEl = qs('#message-input');
  const sendBtn = qs('#send-btn');
  const fileInput = qs('#file-input');
  const searchInput = qs('#global-search');
  const chatTitle = qs('#chat-title');
  const chatSub = qs('#chat-sub');
  const chatAvatar = qs('#chat-avatar');
  const btnClear = qs('#btn-clear');
  const btnExport = qs('#btn-export');

  // Data model in localStorage
  const STORAGE_KEY = 'ultramessenger.v1';
  let store = {
    conversations: [],
    selectedId: null
  };

  // Seed example if empty
  function seed() {
    const sampleConv = {
      id: 'conv-alex',
      name: 'Alex Johnson',
      initials: 'AJ',
      lastSeen: Date.now() - 1000*60*7,
      messages: [
        { id: uid(), sender: 'them', text: "Hey — did you try the new demo?", ts: Date.now() - 1000*60*60 },
        { id: uid(), sender: 'me', text: "Not yet. Let's try it now!", ts: Date.now() - 1000*60*57 },
        { id: uid(), sender: 'them', text: "Cool — I'll send a screenshot.", ts: Date.now() - 1000*60*55 }
      ]
    };
    const other = {
      id: 'conv-zoe',
      name: 'Zoe Chen',
      initials: 'ZC',
      lastSeen: Date.now() - 1000*60*60*24,
      messages: [
        { id: uid(), sender:'them', text: "Meeting at 3pm? Confirm.", ts: Date.now() - 1000*60*60*6 }
      ]
    };
    store.conversations = [sampleConv, other];
    store.selectedId = sampleConv.id;
    save();
  }

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }
  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw){
      try{
        store = JSON.parse(raw);
      }catch(e){
        console.error('corrupt store, resetting', e);
        localStorage.removeItem(STORAGE_KEY);
        seed();
      }
    } else {
      seed();
    }
  }

  // Rendering
  function renderConversations(filter=''){
    conversationsEl.innerHTML = '';
    const list = store.conversations
      .map(c => ({
        ...c,
        lastMsg: c.messages[c.messages.length-1],
        lastTs: c.messages.length ? c.messages[c.messages.length-1].ts : c.lastSeen
      }))
      .sort((a,b) => b.lastTs - a.lastTs);

    const filtered = list.filter(c => {
      const q = filter.trim().toLowerCase();
      if(!q) return true;
      if (c.name.toLowerCase().includes(q)) return true;
      return c.messages.some(m => (m.text || '').toLowerCase().includes(q));
    });

    for(const conv of filtered){
      const item = document.createElement('div');
      item.className = 'conv-item' + (conv.id===store.selectedId ? ' active' : '');
      item.dataset.id = conv.id;
      item.setAttribute('role','listitem');

      item.innerHTML = `
        <div class="avatar" aria-hidden="true">${conv.initials || conv.name.split(' ').map(s=>s[0]).join('').slice(0,2)}</div>
        <div class="conv-main">
          <h3>${escapeHtml(conv.name)}</h3>
          <p>${conv.lastMsg ? escapeHtml(truncate(conv.lastMsg.text || '[attachment]', 46)) : '<span class="small">No messages</span>'}</p>
        </div>
        <div class="conv-meta small">${conv.lastMsg ? formatTime(conv.lastMsg.ts) : ''}</div>
      `;
      item.addEventListener('click', () => {
        store.selectedId = conv.id; save(); renderAll();
      });
      conversationsEl.appendChild(item);
    }
  }

  function renderMessages(scrollToBottom=true){
    messagesEl.innerHTML = '';
    const conv = store.conversations.find(c => c.id === store.selectedId);
    if(!conv){ messagesEl.innerHTML = '<div class="small">No conversation selected</div>'; return; }

    chatTitle.textContent = conv.name;
    chatAvatar.textContent = conv.initials || conv.name.split(' ').map(s=>s[0]).join('').slice(0,2);
    chatSub.textContent = 'Online · last active ' + new Date(conv.lastSeen).toLocaleString();

    // Group by day
    let lastDay = null;
    conv.messages.forEach(msg => {
      const d = new Date(msg.ts);
      const day = d.toDateString();
      if (day !== lastDay){
        lastDay = day;
        const sep = document.createElement('div');
        sep.className = 'day-sep';
        sep.textContent = d.toLocaleDateString();
        messagesEl.appendChild(sep);
      }

      const row = document.createElement('div');
      row.className = 'msg-row ' + (msg.sender === 'me' ? 'me' : 'them');

      const bubble = document.createElement('div');
      bubble.className = 'bubble msg ' + (msg.sender === 'me' ? 'me' : 'them');
      bubble.innerHTML = renderMessageBody(msg);

      const meta = document.createElement('div');
      meta.className = 'meta small';
      meta.innerHTML = `<span>${formatTime(msg.ts)}</span>`;

      // actions
      const actions = document.createElement('div');
      actions.className = 'msg-actions';
      actions.innerHTML = `
        <button class="action-btn" title="Edit">✏️</button>
        <button class="action-btn" title="Delete">🗑️</button>
        <button class="action-btn" title="Copy">📋</button>
      `;
      // wire actions
      const [editBtn, delBtn, copyBtn] = actions.querySelectorAll('button');
      editBtn.addEventListener('click', () => startEdit(msg.id));
      delBtn.addEventListener('click', () => {
        if(confirm('Delete this message?')){
          deleteMessage(msg.id);
        }
      });
      copyBtn.addEventListener('click', () => {
        navigator.clipboard?.writeText(msg.text || '[attachment]').then(()=> alert('Copied'));
      });

      bubble.appendChild(meta);
      bubble.appendChild(actions);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
    });

    if(scrollToBottom){
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  }

  function renderMessageBody(msg){
    // supports text and optional image dataURL
    let html = '';
    if (msg.image){
      html += `<div class="file-preview"><img class="preview-thumb" src="${msg.image}" alt="Attached image"></div>`;
    }
    if (msg.text){
      html += `<div>${escapeHtml(msg.text).replace(/\n/g,'<br>')}</div>`;
    }
    return html || '<em>(empty)</em>';
  }

  function renderAll(){
    renderConversations(searchInput.value);
    renderMessages();
  }

  // Actions
  function addMessage(convId, message){
    const conv = store.conversations.find(c => c.id === convId);
    if(!conv) return;
    conv.messages.push(message);
    conv.lastSeen = message.ts;
    save();
    renderAll();
  }

  function deleteMessage(msgId){
    const conv = store.conversations.find(c => c.id === store.selectedId);
    if(!conv) return;
    conv.messages = conv.messages.filter(m => m.id !== msgId);
    save(); renderAll();
  }

  function startEdit(msgId){
    const conv = store.conversations.find(c => c.id === store.selectedId);
    const msg = conv.messages.find(m => m.id === msgId);
    if(!msg) return;
    // populate composer with message text for edit
    inputEl.value = msg.text || '';
    inputEl.focus();
    // change send button to "Save"
    sendBtn.textContent = 'Save';
    sendBtn.dataset.editing = msgId;
  }

  function applyEdit(convId, msgId, newText){
    const conv = store.conversations.find(c => c.id === convId);
    const msg = conv.messages.find(m => m.id === msgId);
    if(!msg) return;
    msg.text = newText;
    msg.edited = true;
    msg.ts = Date.now(); // update timestamp to now
    save();
    renderAll();
    sendBtn.textContent = 'Send';
    delete sendBtn.dataset.editing;
  }

  function sendMessageFromComposer(imageData=null){
    const text = inputEl.value.trim();
    const isEditing = sendBtn.dataset.editing;
    if (isEditing){
      applyEdit(store.selectedId, isEditing, inputEl.value);
      inputEl.value = '';
      return;
    }

    if (!text && !imageData) return;
    const message = {
      id: uid(),
      sender: 'me',
      text: text || '',
      image: imageData || null,
      ts: Date.now()
    };
    addMessage(store.selectedId, message);
    inputEl.value = '';
    fileInput.value = '';

    // simulate a typing reply for demo if sending to "them"
    simulateReply(store.selectedId);
  }

  function simulateReply(convId){
    // A quick simulated reply — not necessary but makes UI feel alive.
    // Keep it short and optional
    const conv = store.conversations.find(c => c.id === convId);
    if(!conv) return;
    // show typing indicator
    const typingId = 'typing-' + uid();
    const typingMsg = { id: typingId, sender: 'them', text: '...', ts: Date.now() };
    conv.messages.push(typingMsg);
    save(); renderAll();
    setTimeout(() => {
      // replace typing with an actual reply
      conv.messages = conv.messages.filter(m => m.id !== typingId);
      conv.messages.push({ id: uid(), sender:'them', text: randomReply(), ts: Date.now() });
      save(); renderAll();
    }, 900 + Math.random()*1600);
  }

  function randomReply(){
    const replies = [
      "Nice — that looks good!",
      "Got it, thanks!",
      "I'll check and get back to you.",
      "Haha love it 😄",
      "Let's discuss this in the meeting."
    ];
    return replies[Math.floor(Math.random()*replies.length)];
  }

  // File attachment handling (images only)
  fileInput.addEventListener('change', ev => {
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    if(!file.type.startsWith('image/')) { alert('Only images are supported in this demo.'); return; }
    const reader = new FileReader();
    reader.onload = () => {
      // put image into composer and send immediately to simulate attachment send
      sendMessageFromComposer(reader.result);
    };
    reader.readAsDataURL(file);
  });

  // Send handlers
  sendBtn.addEventListener('click', () => sendMessageFromComposer());
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // Search
  searchInput.addEventListener('input', () => {
    renderConversations(searchInput.value);
  });

  // Clear conv
  btnClear.addEventListener('click', () => {
    if(!store.selectedId) return;
    if(!confirm('Clear all messages in this conversation?')) return;
    const conv = store.conversations.find(c => c.id === store.selectedId);
    conv.messages = [];
    conv.lastSeen = Date.now();
    save(); renderAll();
  });

  // Export conv as JSON
  btnExport.addEventListener('click', () => {
    const conv = store.conversations.find(c => c.id === store.selectedId);
    if(!conv) return alert('No conversation selected');
    const blob = new Blob([JSON.stringify(conv, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${conv.name.replace(/\s+/g,'_')}_conversation.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Helpers
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function truncate(s, n=40){ if(!s) return ''; return s.length > n ? s.slice(0,n-1)+'…' : s; }

  // Initial load
  load();
  renderAll();

  // Allow keyboard navigation to focus message list to scroll with arrows
  messagesEl.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowDown') messagesEl.scrollBy({top:80,behavior:'smooth'});
    if(e.key === 'ArrowUp') messagesEl.scrollBy({top:-80,behavior:'smooth'});
  });

  // For demonstration: click conversation area to create a new conversation
  conversationsEl.addEventListener('dblclick', () => {
    const name = prompt('New conversation name?');
    if(!name) return;
    const conv = { id: 'conv-'+uid(), name, initials: name.split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase(), lastSeen: Date.now(), messages: [] };
    store.conversations.push(conv);
    store.selectedId = conv.id;
    save(); renderAll();
  });

})();
</script>
</body>
</html>